# .github/workflows/build-and-push-ai-backend.yml

name: Build, Push, and Cleanup AI Backend Docker Image

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE_REPO: roma3213/maryrose-app
  DOCKER_IMAGE_TAG: v3

jobs:
  build-push-cleanup:
    name: Build, Push and Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}
          # --- ИЗМЕНЕНИЕ: ИСПОЛЬЗУЕМ DOCKER HUB КАК КЕШ ---
          # type=registry - тип кеша
          # ref=${{ env.DOCKER_IMAGE }} - ссылка на образ, который использовать как кеш
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}
          # Сохраняем кеш обратно в образ. mode=max нужен для этого.
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }},mode=max

      - name: Prune builder cache and local images on runner
        if: always()
        run: |
          docker buildx prune -a -f
          docker image prune -a -f
