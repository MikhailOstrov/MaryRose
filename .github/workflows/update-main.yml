# .github/workflows/build-and-push-ai-backend.yml

name: Build, Push, and Cleanup AI Backend Docker Image

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: roma3213/maryrose-app:v3

jobs:
  build-push-cleanup:
    name: Build, Push and Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}
          cache-from: type=gha,scope=${{ github.workflow }}
          cache-to: type=gha,scope=${{ github.workflow }},mode=max

      # --- ШАГ 1: ОЧИСТКА RUNNER'А ---
      - name: Prune builder cache and local images
        if: always() # Выполнять всегда, даже если предыдущий шаг упал
        run: |
          echo "Cleaning up builder cache..."
          docker buildx prune -a -f
          echo "Cleaning up local Docker images..."
          docker image prune -a -f

      # --- ШАГ 2: ОЧИСТКА DOCKER HUB ---
      - name: Cleanup old untagged images on Docker Hub
        if: success() # Выполнять только после успешного пуша
        uses: docker-practice/actions-tag-deleter@v1.1.0
        with:
          # Указываем репозиторий для очистки
          repo: "roma3213/maryrose-app"
          # Удаляем ТОЛЬКО образы без тегов
          untagged: "true"
          # Оставляем 0 самых свежих безымянных образов (т.е. удаляем все)
          retain_last_count: 0
          # Логин и пароль для доступа к Docker Hub
          user: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          # Сначала запустите с 'true', чтобы посмотреть, что он хочет удалить.
          # Затем поменяйте на 'false' для реального удаления.
          dry_run: "true"
